CREATE DATABASE COMPANY;

USE COMPANY;

CREATE TABLE EMPLOYEE (SSN INT PRIMARY KEY, NAME VARCHAR(20),SEX VARCHAR(10),SALARY INT,
SUPERSSN INT, DNO INT, FOREIGN KEY (SUPERSSN) REFERENCES EMPLOYEE(SSN));

CREATE TABLE DEPARTMENT(DNO INT PRIMARY KEY, DNAME VARCHAR(30), MGRSSN INT, MGRSD DATE,FOREIGN KEY (MGRSSN) REFERENCES EMPLOYEE(SSN));

CREATE TABLE DLOC(DNO INT, DLOC VARCHAR(30), FOREIGN KEY (DNO) REFERENCES DEPARTMENT(DNO));

CREATE TABLE PROJECT( PNO INT PRIMARY KEY, PNAME VARCHAR(50), PLOCATION VARCHAR(30), DNO
INT, FOREIGN KEY (DNO) REFERENCES DEPARTMENT(DNO));

CREATE TABLE WORKSON(SSN INT, PNO INT, HOURS INT, FOREIGN KEY (SSN) REFERENCES EMPLOYEE(SSN),FOREIGN KEY (PNO) REFERENCES PROJECT(PNO));

-- INSERT INTO EMPLOYEE
INSERT INTO EMPLOYEE (SSN, NAME, SEX, SALARY, SUPERSSN, DNO) VALUES
(111111111, 'John Doe', 'Male', 60000, NULL, 1),
(222222222, 'Jane Smith', 'Female', 55000, 111111111, 1),
(333333333, 'Bob Johnson', 'Male', 50000, 111111111, 2),
(444444444, 'Alice Williams', 'Female', 65000, 333333333, 2),
(555555555, 'Charlie Brown', 'Male', 70000, NULL, 3);

-- INSERT INTO DEPARTMENT
INSERT INTO DEPARTMENT (DNO, DNAME, MGRSSN, MGRSD) VALUES
(1, 'HR Department', 111111111, '2023-01-01'),
(2, 'IT Department', 333333333, '2023-01-01'),
(3, 'Marketing Department', NULL, NULL),
(4, 'Finance Department', NULL, NULL),
(5, 'Operations Department', 555555555, '2023-01-01');

-- INSERT INTO DLOC
INSERT INTO DLOC (DNO, DLOC) VALUES
(1, 'New York'),
(2, 'San Francisco'),
(3, 'Chicago'),
(4, 'Los Angeles'),
(5, 'Seattle');

-- INSERT INTO PROJECT
INSERT INTO PROJECT (PNO, PNAME, PLOCATION, DNO) VALUES
(101, 'Employee Portal', 'New York', 2),
(102, 'Marketing Campaign', 'Chicago', 3),
(103, 'Financial System Upgrade', 'Los Angeles', 4),
(104, 'Operations Efficiency', 'Seattle', 5),
(105, 'Employee Training', 'New York', 1);

-- INSERT INTO WORKSON
INSERT INTO WORKSON (SSN, PNO, HOURS) VALUES
(111111111, 101, 40),
(222222222, 102, 35),
(333333333, 103, 30),
(444444444, 104, 25),
(555555555, 105, 20);


ALTER TABLE EMPLOYEE ADD CONSTRAINT FOREIGN KEY (DNO) REFERENCES DEPARTMENT(DNO);


1)
SELECT DISTINCT PROJECT.PNO FROM PROJECT JOIN DEPARTMENT ON PROJECT.DNO = DEPARTMENT.DNO
JOIN EMPLOYEE ON DEPARTMENT.MGRSSN = EMPLOYEE.SSN LEFT JOIN WORKSON ON PROJECT.PNO = WORKSON.PNO WHERE EMPLOYEE.NAME LIKE '%Doe%' OR WORKSON.SSN IN (SELECT SSN FROM EMPLOYEE WHERE NAME LIKE '%Doe%');

2)
SELECT W.SSN, SALARY AS OLD_SALARY, SALARY*1.1 AS NEW_SALARY FROM WORKSON W JOIN EMPLOYEE E ON W.SSN=E.SSN AND W.PNO=(SELECT PNO FROM PROJECT WHERE PNAME='Marketing Campaign');

3)
SELECT SUM(SALARY), MAX(SALARY), MIN(SALARY), AVG(SALARY) FROM EMPLOYEE WHERE DNO = (SELECT DNO FROM DEPARTMENT WHERE DNAME="HR Department");

4)
SELECT DISTINCT E.NAME
FROM EMPLOYEE E
WHERE NOT EXISTS (
    SELECT PNO
    FROM PROJECT P
    WHERE P.DNO = 5
    AND NOT EXISTS (
        SELECT SSN
        FROM WORKSON W
        WHERE W.PNO = P.PNO
        AND W.SSN = E.SSN
    )
);

5)
SELECT DNO, COUNT(*) AS NumEmployees
FROM EMPLOYEE
WHERE DNO IN (
    SELECT DNO
    FROM EMPLOYEE
    GROUP BY DNO
    HAVING COUNT(*) > 5
)
AND SALARY > 600000
GROUP BY DNO;

6)
CREATE VIEW EmployeeDetails AS
SELECT E.NAME AS EmployeeName, D.DNAME AS DepartmentName, DL.DLOC AS DepartmentLocation
FROM EMPLOYEE E
JOIN DEPARTMENT D ON E.DNO = D.DNO
JOIN DLOC DL ON D.DNO = DL.DNO;

7)
DELIMITER //

CREATE TRIGGER before_delete_project
BEFORE DELETE ON PROJECT
FOR EACH ROW
BEGIN
    IF (SELECT COUNT(*)
    FROM WORKSON
    WHERE PNO = OLD.PNO) > 0 THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Cannot delete project. It is currently being worked on by employees.';
    END IF;
END //

DELIMITER ;








